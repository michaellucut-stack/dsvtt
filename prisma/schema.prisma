// ============================================================================
// DSVTT (VTT Forge) — Prisma Schema v1
// ============================================================================

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearchPostgres"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Enums ──────────────────────────────────────────────────────────────────

enum RoomStatus {
  WAITING
  ACTIVE
  PAUSED
  ENDED
}

enum PlayerRole {
  DIRECTOR
  PLAYER
}

enum SessionStatus {
  SETUP
  ACTIVE
  PAUSED
  ENDED
}

enum ActorType {
  DIRECTOR
  PLAYER
  AI
  SYSTEM
}

enum ChatChannel {
  IC
  OOC
  WHISPER
  SYSTEM
}

enum TokenLayer {
  BACKGROUND
  TOKEN
  EFFECT
  GM
}

// ─── Models ─────────────────────────────────────────────────────────────────

model User {
  id           String   @id @default(uuid()) @db.Uuid
  email        String   @unique
  passwordHash String
  displayName  String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  directedRooms  Room[]          @relation("RoomDirector")
  roomPlayers    RoomPlayer[]
  characters     Character[]
  characterData  CharacterData[] @relation("CharacterDataOwner")

  @@index([email])
  @@map("users")
}

model Room {
  id           String     @id @default(uuid()) @db.Uuid
  name         String
  status       RoomStatus @default(WAITING)
  directorId   String     @db.Uuid
  maxPlayers   Int        @default(8)
  gameSystemId String?    @db.Uuid
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  director     User          @relation("RoomDirector", fields: [directorId], references: [id], onDelete: Cascade)
  gameSystem   GameSystem?   @relation(fields: [gameSystemId], references: [id], onDelete: SetNull)
  players      RoomPlayer[]
  gameSessions GameSession[]

  @@index([directorId])
  @@index([status])
  @@index([gameSystemId])
  @@index([createdAt])
  @@map("rooms")
}

model RoomPlayer {
  id       String     @id @default(uuid()) @db.Uuid
  roomId   String     @db.Uuid
  userId   String     @db.Uuid
  role     PlayerRole
  joinedAt DateTime   @default(now())

  room Room @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([roomId, userId])
  @@index([roomId])
  @@index([userId])
  @@map("room_players")
}

model GameSession {
  id         String        @id @default(uuid()) @db.Uuid
  roomId     String        @db.Uuid
  status     SessionStatus @default(SETUP)
  startedAt  DateTime      @default(now())
  endedAt    DateTime?
  eventCount Int           @default(0)

  room          Room            @relation(fields: [roomId], references: [id], onDelete: Cascade)
  eventLogs     GameEventLog[]
  maps          GameMap[]
  chatMessages  ChatMessage[]
  diceRolls     DiceRollLog[]
  npcs          Npc[]
  characters    Character[]
  sharedNotes   SharedNote[]
  snapshots     StateSnapshot[]
  characterData CharacterData[]

  @@index([roomId])
  @@index([status])
  @@index([startedAt])
  @@map("game_sessions")
}

model GameEventLog {
  id             String    @id @default(uuid()) @db.Uuid
  sessionId      String    @db.Uuid
  sequenceNumber Int
  eventType      String
  payload        Json
  actorId        String
  actorType      ActorType
  timestamp      DateTime  @default(now())
  metadata       Json      @default("{}")

  session GameSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([sessionId, sequenceNumber])
  @@index([sessionId])
  @@index([eventType])
  @@index([timestamp])
  @@map("game_event_logs")
}

model GameMap {
  id            String   @id @default(uuid()) @db.Uuid
  sessionId     String   @db.Uuid
  name          String
  backgroundUrl String?
  gridWidth     Int      @default(20)
  gridHeight    Int      @default(15)
  gridSize      Int      @default(64)
  createdAt     DateTime @default(now())

  session    GameSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  tokens     Token[]
  fogRegions FogRegion[]

  @@index([sessionId])
  @@map("game_maps")
}

model Token {
  id       String     @id @default(uuid()) @db.Uuid
  mapId    String     @db.Uuid
  ownerId  String
  name     String
  imageUrl String?
  x        Float
  y        Float
  width    Float      @default(1)
  height   Float      @default(1)
  layer    TokenLayer @default(TOKEN)
  visible  Boolean    @default(true)

  map  GameMap @relation(fields: [mapId], references: [id], onDelete: Cascade)
  npcs Npc[]

  @@index([mapId])
  @@index([ownerId])
  @@map("tokens")
}

model FogRegion {
  id       String  @id @default(uuid()) @db.Uuid
  mapId    String  @db.Uuid
  name     String?
  points   Json
  revealed Boolean @default(false)

  map GameMap @relation(fields: [mapId], references: [id], onDelete: Cascade)

  @@index([mapId])
  @@map("fog_regions")
}

model ChatMessage {
  id           String                   @id @default(uuid()) @db.Uuid
  sessionId    String                   @db.Uuid
  senderId     String
  senderName   String
  channel      ChatChannel
  content      String
  recipientId  String?
  timestamp    DateTime                 @default(now())
  searchVector Unsupported("tsvector")?

  session GameSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([senderId])
  @@index([channel])
  @@index([timestamp])
  @@map("chat_messages")
}

model DiceRollLog {
  id        String   @id @default(uuid()) @db.Uuid
  sessionId String   @db.Uuid
  playerId  String
  formula   String
  results   Json
  total     Int
  isPrivate Boolean  @default(false)
  timestamp DateTime @default(now())

  session GameSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([playerId])
  @@index([timestamp])
  @@map("dice_roll_logs")
}

model Npc {
  id        String  @id @default(uuid()) @db.Uuid
  sessionId String  @db.Uuid
  name      String
  stats     Json    @default("{}")
  notes     String?
  tokenId   String? @db.Uuid

  session GameSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  token   Token?      @relation(fields: [tokenId], references: [id], onDelete: SetNull)

  @@index([sessionId])
  @@index([tokenId])
  @@map("npcs")
}

model Character {
  id           String                   @id @default(uuid()) @db.Uuid
  sessionId    String                   @db.Uuid
  userId       String                   @db.Uuid
  name         String
  stats        Json                     @default("{}")
  notes        String?
  inventory    Json                     @default("[]")
  searchVector Unsupported("tsvector")?

  session GameSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user    User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([userId])
  @@map("characters")
}

model SharedNote {
  id           String                   @id @default(uuid()) @db.Uuid
  sessionId    String                   @db.Uuid
  title        String
  content      String
  updatedBy    String?
  updatedAt    DateTime                 @updatedAt
  searchVector Unsupported("tsvector")?

  session GameSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([updatedAt])
  @@map("shared_notes")
}

model StateSnapshot {
  id             String   @id @default(uuid()) @db.Uuid
  sessionId      String   @db.Uuid
  sequenceNumber Int
  state          Json
  createdAt      DateTime @default(now())

  session GameSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([sessionId, sequenceNumber])
  @@index([sessionId])
  @@index([createdAt])
  @@map("state_snapshots")
}

// ─── Phase 2: Game System Models ────────────────────────────────────────────

model GameSystem {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @unique
  version     String
  source      String
  description String?
  /** Path to the game_rules/ folder on disk. */
  rulesPath   String
  /** Parsed game system data cached as JSON. */
  parsedData  Json     @default("{}")
  /** Whether the system is ready for use (parsing completed). */
  isReady     Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  rooms              Room[]
  ruleConstraints    RuleConstraint[]
  systemConfigs      GameSystemConfig[]
  characterTemplates CharacterTemplate[]
  abilities          Ability[]

  @@index([name])
  @@index([isReady])
  @@map("game_systems")
}

model RuleConstraint {
  id           String  @id @default(uuid()) @db.Uuid
  gameSystemId String  @db.Uuid
  /** Constraint identifier within the system (e.g., "movement:speed"). */
  constraintId String
  name         String
  /** Constraint scope: movement, action_economy, ability_use, combat, condition, resource, general. */
  scope        String
  /** Whether this constraint is enabled by default. */
  enabled      Boolean @default(true)
  /** Evaluation priority (lower = higher priority). */
  priority     Int     @default(100)
  /** Constraint configuration as JSON (thresholds, limits, etc.). */
  config       Json    @default("{}")
  description  String?

  gameSystem GameSystem @relation(fields: [gameSystemId], references: [id], onDelete: Cascade)

  @@unique([gameSystemId, constraintId])
  @@index([gameSystemId])
  @@index([scope])
  @@map("rule_constraints")
}

model CharacterTemplate {
  id           String  @id @default(uuid()) @db.Uuid
  gameSystemId String  @db.Uuid
  /** Template version. */
  version      String
  /** Section ordering as JSON array of {id, label} objects. */
  sectionOrder Json
  /** All field definitions as JSON array. */
  fields       Json
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  gameSystem     GameSystem      @relation(fields: [gameSystemId], references: [id], onDelete: Cascade)
  characterData  CharacterData[]

  @@unique([gameSystemId, version])
  @@index([gameSystemId])
  @@map("character_templates")
}

model CharacterData {
  id             String   @id @default(uuid()) @db.Uuid
  templateId     String   @db.Uuid
  sessionId      String   @db.Uuid
  userId         String   @db.Uuid
  /** Character field values as JSON object. */
  data           Json     @default("{}")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  template CharacterTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  session  GameSession        @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user     User               @relation("CharacterDataOwner", fields: [userId], references: [id], onDelete: Cascade)

  @@index([templateId])
  @@index([sessionId])
  @@index([userId])
  @@map("character_data")
}

model Ability {
  id           String  @id @default(uuid()) @db.Uuid
  gameSystemId String  @db.Uuid
  name         String
  /** Tab classification: actions, maneuvers, triggered. */
  tab          String
  /** Original category from emoji: melee, ranged, area, etc. */
  category     String
  actionType   String
  keywords     Json    @default("[]")
  distance     String?
  targets      String?
  powerRollCharacteristic String?
  powerRollTiers Json?
  effect       String?
  trigger      String?
  special      String?
  cost         String?
  /** Source class (e.g., "Censor"). */
  sourceClass  String?
  /** Source ancestry (e.g., "Human"). */
  sourceAncestry String?
  /** Source kit. */
  sourceKit    String?
  /** Minimum level required. */
  levelRequired Int    @default(1)
  /** Whether this is a signature ability. */
  isSignature  Boolean @default(false)
  /** Full raw markdown text. */
  rawText      String?

  gameSystem GameSystem @relation(fields: [gameSystemId], references: [id], onDelete: Cascade)

  @@index([gameSystemId])
  @@index([tab])
  @@index([sourceClass])
  @@index([levelRequired])
  @@map("abilities")
}

model GameSystemConfig {
  id           String  @id @default(uuid()) @db.Uuid
  gameSystemId String  @db.Uuid
  /** Configuration key (e.g., "maxActionsPerTurn", "movementCostPerSquare"). */
  key          String
  /** Configuration value as JSON. */
  value        Json
  /** Whether this config can be modified by the Director. */
  editable     Boolean @default(true)
  /** Default value (for reset). */
  defaultValue Json
  label        String?
  description  String?

  gameSystem GameSystem @relation(fields: [gameSystemId], references: [id], onDelete: Cascade)

  @@unique([gameSystemId, key])
  @@index([gameSystemId])
  @@map("game_system_configs")
}
